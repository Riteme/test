M

大力状压 DP。我是记 f(i, W, R) 表示第 i 行，W 记录这一行上 m 个格子是否是水，R 记录 m 个格子是否是干的。`(R << m) | W` 的组合上界是 $3^n$ 个，实际上到不了。转移的时候枚举下一行 m 个格子是否是水源。枚举时候要保证上一行干的格子下面必须有水源。然后检查一下这一行中的石头，算出这一行的 W 和 R，之后转移即可。计算量大概是 $30×3^8×2^8×8$ 这个级别，实际跑得还挺快的。

K

首先 $2 ≤ K ≤ 3$ 有蹊跷。

考虑如果只有 $K = 2$ 的操作。将原序列按下标奇偶分为两个序列，手动模拟一下不难发现这个操作就是把两个序列里面各自一段区间交换一下。这个东西用支持 split 的平衡树（treap/splay）很好做。

实际上 $K = 3$ 也是类似的做法。为了同时兼容两种操作，我们把序列按下标模 $6$ 的结果切为 $6$ 个，然后在这 $6$ 个序列的平衡树上大力切割、交换区间，最后分别合并起来即可。

查询区间和就在这 $6$ 棵平衡树上单独查。