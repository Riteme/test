**做法**：从区间 $[1,\ n]$ 开始。找到区间 $[l,\ r]$ 中的最大值位置 $m$（$l \leqslant m \leqslant r$）。然后对 $m$ 左边的 $i$ 从右至左进行枚举，同时维护 $[i,\ m]$ 内的最小值 $x$，以及 $m$ 右边的一个单调右移的指针 $j$，使得 $[m,\ j]$ 内的最小值不小于 $x$，并且让 $j$ 尽可能靠右。于是在 $[i,\ j]$ 内的最小值就是 $x$，最大值就是 $a[m]$。用 $x\cdot a[m]$ 去更新长度 $j - i + 1$ 的答案。对于 $m$ 右边的 $i$ 类似处理。之后对于 $[l,\ m - 1]$ 和 $[m + 1,\ r]$ 两个区间递归处理。

**正确性**：考虑区间长度 $k$ 的答案对应的区间 $[l,\ r]$，其最大值取在 $u$，最小值取在 $v$。若 $v < u$，在答案不变的情况下尽可能将答案区间往右边移动。这样在递归算法的 $m = u$，左边枚举的 $i$ 枚举到 $l$ 时，$j$ 就恰好对应于答案区间的 $r$。对于 $v > u$ 同理。

**复杂度**：类似于快速排序。